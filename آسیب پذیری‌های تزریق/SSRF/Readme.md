### حمله SSRF چیست؟
#### Server-Side Request Forgery (SSRF) یک آسیب‌پذیری امنیتی وب است که به مهاجم اجازه می‌دهد تا برنامه سمت سرور را وادار کند تا درخواست‌های HTTP را به دامنه دلخواه خود به انتخاب مهاجم ارسال کند.

![](https://github.com/Fire-Null/Security-solutions/blob/main/%D8%A2%D8%B3%DB%8C%D8%A8%20%D9%BE%D8%B0%DB%8C%D8%B1%DB%8C%E2%80%8C%D9%87%D8%A7%DB%8C%20%D8%AA%D8%B2%D8%B1%DB%8C%D9%82/SSRF/image2.png)


#### تاثیر حملات SSRF چیست؟

* یک حمله موفقیت‌آمیز SSRF اغلب می‌تواند منجر به اقدامات غیرمجاز  یا دسترسی به داده‌ها در داخل سازمان شود، چه در خود برنامه آسیب‌پذیر یا در سایر سیستم‌های پشتیبان که برنامه می‌تواند با آنها ارتباط برقرار کند. در برخی شرایط، آسیب‌پذیری SSRF ممکن است به مهاجم اجازه اجرای دستور دلخواه را بدهد.

> حمله به سرور از طریق خود سرور

* در یک حمله SSRF علیه خود سرور، مهاجم برنامه را وادار می‌کند تا یک درخواست HTTP را از طریق رابط شبکه Loopback  خود به سرور میزبان برنامه بازگرداند. این معمولاً شامل ارائه یک URL با نام میزبان مانند 127.0.0.1 (یک آدرس IP رزرو شده که به آداپتور Loopback اشاره می‌کند) یا localhost (نامی که معمولاً برای همان آداپتور استفاده می‌شود) است.

* به عنوان مثال، یک برنامه کاربردی خرید را در نظر بگیرید که به کاربر امکان می‌دهد ببیند آیا یک کالا در یک فروشگاه خاص موجود است یا خیر. برای ارائه اطلاعات موجودی، برنامه باید بسته به محصول و فروشگاه مورد نظر از APIهای پشتیبان REST مختلف پرس و جو کند. این تابع با ارسال URL به API back-end مربوطه از طریق یک درخواست HTTP جلویی پیاده‌سازی می‌شود. بنابراین هنگامی که یک کاربر وضعیت موجودی یک کالا را مشاهده می‌کند، مرورگر او درخواستی مانند درخواست زیر را می‌دهد:

```url
POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
```
```url
Content-Length: 118

stockApi=http://stock.weliketoshop.net:8080/product/stock/check%3FproductId%3D6%26storeId%3D
```

* این باعث می‌شود سرور درخواستی را به URL مشخص شده ارسال کند، وضعیت موجودی را بازیابی کند و آن را به کاربر برگرداند.

* در این شرایط، یک مهاجم می‌تواند درخواست را تغییر دهد تا یک URL محلی برای خود سرور مشخص کند. مثال:

```url
POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://localhost/admin
```
> در اینجا سرور محتوای URL /admin را دریافت کرده و آن را به کاربر باز می‌گرداند.

#### حملات SSRF علیه سایر سیستم‌های بک‌اند

* در این نوع حملات، برنامه قادر به تعامل با سایر سیستم‌های پشتیبان است که مستقیماً توسط کاربران قابل دسترسی نیستند. این سیستم‌ها اغلب دارای آدرس‌های IP خصوصی غیرقابل مسیریابی هستند. از آنجایی که سیستم‌های بک‌اند معمولاً توسط توپولوژی شبکه محافظت می‌شوند، اغلب وضعیت امنیتی ضعیف‌تری دارند. در بسیاری از موارد، سیستم‌های بک‌اند داخلی دارای قابلیت‌های حساسی هستند که هر کسی که قادر به تعامل با سیستم‌ها باشد
```url 
POST /product/stock HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 118

stockApi=http://192.168.0.68/admin
```
#### دور زدن دفاع‌های رایج SSRF

* SSRF   با فیلترهای ورودی مبتنی بر لیست سیاه
> برخی از برنامه‌ها ورودی‌های حاوی نام میزبان مانند 127.0.0.1 و localhost یاURL های حساس مانند /admin را مسدود می‌کنند. در این شرایط، اغلب می‌توانید با استفاده از تکنیک‌های مختلف فیلتر را دور بزنید:

    1- با استفاده از نمایش IP جایگزین 127.0.0.1، مانند 2130706433، 017700000001، یا 127.1.
    2-  مبهم‌سازی رشته‌های مسدودشده با استفاده از رمزگذاری URL یا تغییر حروف کوچک.
* SSRF با فیلترهای ورودی مبتنی بر لیست سفید
> برخی از برنامه‌ها فقط ورودی‌هایی را مجاز می‌کنند که با لیست سفید مقادیر مجاز مطابقت داشته باشد. در این شرایط، گاهی اوقات می‌توانید با استفاده از ناهماهنگی‌ها در تجزیه URL، فیلتر را دور بزنید.
    1- می‌توانید با استفاده از کاراکتر @، اعتبارنامه‌ها را قبل از نام میزبان در URL جاسازی کنید.

```https://expected-host@evil-host```

2-  می‌توانید از کاراکتر # برای نشان دادن یک قطعه URL استفاده کنید.

```https://evil-host#expected-host```

3- می‌توانید از سلسله‌مراتب نام‌گذاری DNS برای قرار دادن ورودی موردنیاز در یک نام DNS کاملاً واجد شرایط که کنترل می‌کنید، استفاده کنید.

```https://expected-host.evil-host```

### آسیب‌پذیری‌های Blind SSRF
#### آسیب‌پذیری‌های Blind SSRF زمانی به وجود می‌آیند که می‌توان برنامه‌ای را وادار کرد که یک درخواست HTTP  پشتیبان را به URL ارائه‌شده صادر کند، اما پاسخ درخواست بک‌اند در پاسخ جلویی برنامه برگردانده نمی‌شود.
> بهره‌برداری از Blind SSRF معمولا سخت‌تر است، اما گاهی اوقات می‌تواند منجر به اجرای کامل کد از راه دور بر روی سرور یا سایر اجزای پشتیبان شود.

#### جلوگیری از حملات SSRF

* لیست سفید و DNS resolution
> یک رویکرد محکم برای اجتناب از SSRF این است که آدرس‌های IP یا نام‌های DNS را که برنامه شما نیاز به دسترسی به آنها دارد در لیست سفید قرار دهید. تنها در صورتی که رویکرد لیست سفید مناسب نیست، باید از لیست سیاه استفاده کنید. ضروری است که ورودی کاربر را به طور مؤثر تأیید کنید.

* رسیدگی به پاسخ
> برای جلوگیری از رسیدن اطلاعات پاسخ به مهاجم، باید مطمئن شوید که پاسخ دریافت شده با آنچه پیش‌بینی شده است مطابقت دارد. به هیچ وجه نباید بدنه پاسخ خام دریافت شده از درخواست آغاز شده توسط سرور به مشتری منتقل شود.
* URL Schema استفاده نشده را غیرفعال کنید
> اگر برنامه شما برای شروع درخواست ها صرفاً به HTTPS یا HTTP وابسته است، فقط به این   URL Schema اجازه دهید. با غیرفعال کردن  URL Schema استفاده نشده، مهاجمان را از ارسال درخواست‌ها از طریق Schemaهای مضر، از جمله  dict://, file:// و gopher:// محروم می‌کنید.
* احراز هویت در سرویس‌های داخلی
> سرویس‌هایی مانند Redis، MongoDB، Elasticsearch و Memcached به‌طور پیش‌فرض درخواست verification نمی‌کنند. یک مهاجم ممکن است با استفاده از آسیب‌پذیری‌های SSRF بدون  verification  به برخی خدمات دسترسی پیدا کند. بنابراین، برای اعمال امنیت ، مطلوب است که هر زمان که می‌توانید، از جمله برای سرویس‌های شبکه محلی، verification  را مجاز کنید.

