### بعضی اوقات از دستورات سیستم عامل به صورت مستقیم و یا غیر مستقیم در بستر وب استفاده می‌شود. اگر ورود های دستورات سیستم عامل به صورت صحیح و کامل بررسی نشود ممکن است مهاجم با ورودی‌های متفاوت دستورات موردنظر خود را اجرا کند. این آسیب‌پذیری بسیار گسترده و خطرناک است چون امکان دسترسی به کلیه منابع سرور اپلیکیشن و یا حتی سایر سرور ها را فراهم می‌کند.

### در تصویر بالا مهاجم با استفاده از آسیب‌پذیری command injection توانسته است اسکریپت bash را سمت سرور اجرا و دسترسی به سرور اپلیکشین بگیرد.

```php
/**
* Get the code from a GET input
* Example - http://example.com/?code=phpinfo();
*/
$code = $_GET['code'];

/**
* Unsafely evaluate the code
* Example - phpinfo();
*/
eval(&quot\$code;&quot);
```

> برای مثال در برنامه زیر ورودی دستور eval بدون هیچ بررسی از کاربر توسط پارامتر code گرفته می شود.

```url
http://example.com/?code=phpinfo();
```
> یا
```url
http://example.com/?code=system('whoami');
```
> حال اگر مهاجم دستورات زبان و یا سیستم عامل را وارد کند می گوییم command injection رخ داده است.

### نحوه جلوگیری از حملات تزریق فرمان OS
#### در حال حاضر موثرترین راه برای پیشگیری از آسیب‌پذیری‌های OS Command Injection، این است که هیچ‌وقت در کد لایه اپلیکیشن به طور مستقیم دستورات OS را استفاده نکنیم. در تمام موارد  استفاده، راه‌های جایگزین ایمن‌تر هم وجود دارد و می‌توان با استفاده از Platform API مناسب، عملکرد مورد نیاز را پیاده‌سازی کرد.
>اگر در شرایط خاصی هیچ راهی جز استفاده از دستورات OS حاوی ورودی کاربر نبود، باید یک روش قدرتمند برای اعتبارسنجی ورودی کاربر پیاده کرد. چند نمونه از روش‌های اعتبارسنجی عبارتند از:
* اعتبارسنجی ورودی با بررسی یک لیست سفید از مقادیر مجاز.
* اطمینان از این که ورودی حتما عدد باشد.
* اطمینان از این که ورودی فقط دارای حروف و اعداد است و هیچ کاراکتر دیگر یا فضای خالی (اسپیس) ندارد.
>هیچ‌وقت سعی نکنید با حذف یا غیرمجازکردن متاکاراکترهای شل ورودی را پاکسازی کنید؛ در عمل این روش بسیار مستعد خطاست و یک نفوذگر می‌تواند چنین روش‌هایی را دور بزند.
استراتژیهای مختلفی برای جلوگیری و یا کاهش آسیب‌پذیری  تزریق فرمان وجود دارد. به منظور اهمیت، آنها عبارتند از:
* بهترین راه حلی که می‌توان پذیرفت اجتناب از اجرای "exec" است چون خطر را از بین می‌برد. هر گونه تلاشی انجام شود تا کار اپلیکیشن در خود اپلیکیشن انجام شود.
* ورودی‌های غیر قابل اعتماد را اعتبارسنجی کنید. همه ورودیهای برنامه که قبلا تایید نشده‌اند باید بررسی شوند تا اطمینان حاصل شود انتظارات برنامه را برآورده میکنند. از "white list validation" استفاده کنید به این معنی که اپلیکیشن ورودی را مطابق آنچه پذیرفته شده تایید میکند و چیزهای دیگر را رد می‌کند.
* اعتبارسنجی ورودی شامل:

    1- مجموعه کاراکتر
    2- طول حداقل و حداکثر
    3- محدوده عددی
    4- محدوده تاریخ
    5- مطابق با الگوی regex
    6- عضویت در یک مجموعه گسسته(فهرست رنگها، ...)
* متاکاراکترهایی که در خط فرمان os دارای معنی هستند را neutralize کنید.
* برای ویندوز، هر یک از کاراکترهای زیر را با علامت ‘^’  پیش از آن قرار دهید و معنای آن را از مفسر خط فرمان خنثی کنید:
```regex
() <> & * | = ؟ ; [] ^ ~ ! . " % @ / \ : + ,
```
* برای لینوکس و یونیکس، هر یک از کاراکترهای زیر را با علامت ‘\’  پیش از آن قرار دهید و معنای آن را از مفسر خط فرمان خنثی کنید: 
```regex
{} () <> & * ‘ | = ؟  ; [] $ - # × ! . " % / \ : + ,
```
* پیاده‌سازی "حداقل امتیاز ": گرچه نمیتواند به جلوگیری از آسیب‌پذیری تزریق فرمان کمک کند، محدود کردن مجوز)مورد استفاده برای اجرای دستورات OS به کاهش آسیب کمک خواهد کرد
